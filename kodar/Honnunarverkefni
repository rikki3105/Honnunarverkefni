import digitalio
import board
import time
from board import *
import glob
import adafruit_dht
import RPi.GPIO as GPIO
import os
import datetime


###### Kveikjum á viftu ######

# Configuration
RELAY_FAN_GPIO_PIN = 26 # BCM pin used to turn RELAY for FAN ON/OFF


try:
	GPIO.setwarnings(False)
	GPIO.setmode(GPIO.BCM)
  # Setting up relay for FAN
	GPIO.setup(RELAY_FAN_GPIO_PIN, GPIO.OUT, initial=GPIO.HIGH) # HIGH MEANS RELAY IS OFF

	GPIO.output(RELAY_FAN_GPIO_PIN,GPIO.LOW) # Turn the FAN ON
	print("FAN IS ON")
	time.sleep(5)
  except KeyboardInterrupt:
	GPIO.cleanup() # resets all GPIO ports used by this function


###### Hitanemi ######
LDR_GPIO_PIN = board.D6

# configure
LDR = digitalio.DigitalInOut(LDR_GPIO_PIN)
LDR.direction = digitalio.Direction.INPUT
# Solid State Relay (SSR)
SSR = digitalio.DigitalInOut(D23)
SSR.direction = digitalio.Direction.OUTPUT


YELLOW_GPIO_PIN = board.D17
led_yellow = digitalio.DigitalInOut(YELLOW_GPIO_PIN)
led_yellow.direction = digitalio.Direction.OUTPUT
GREEN_GPIO_PIN = board.D27
led_green = digitalio.DigitalInOut(GREEN_GPIO_PIN)
led_green.direction = digitalio.Direction.OUTPUT

dhtDevice = adafruit_dht.DHT22(board.D5)

teljari = 1
upphafshitastig = dhtDevice.temperature # Upphafshitastig
deltaT = 0 # breyta til að fylgjast með breyting á hitastigi

while (teljari < 11):
    try:
        hitastig = dhtDevice.temperature
        rakastig = dhtDevice.humidity
        deltaT = hitastig - upphafshitastig
        print(
            "Hitastig: {:.1f} C    Rakastig: {}%  -- deltaT {:.1f}  mæling nr. {}".format(
                hitastig , rakastig, deltaT, teljari
            )
        )
        if hitastig < hitastig+0.5:
          led_yellow.value = True
          time.sleep(0.1)
          SSR.value = False

        elif hitastig > hitastig-0.5: 
          led_yellow.value = True
          time.sleep(0.1)
          SSR.value = False

    except RuntimeError as error:
        # Villur koma reglulega upp - getur verið erfitt að lesa gildi nemans, bara reyna aftur
        print(error.args[0])
        time.sleep(2.0)
        continue
    except Exception as error:
        dhtDevice.exit()
        raise error

    time.sleep(2.0)
    teljari = teljari + 1
